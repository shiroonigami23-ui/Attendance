<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FaceAttend - Facial Recognition Attendance System</title>
    <link rel="stylesheet" href="style.css">

    <!-- Third-party Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs - This script sets up the global 'window.firebase' object -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js';
        
        const app = initializeApp(firebaseConfig);
        
        // Make Firebase services globally available for all our scripts
        window.firebase = {
            auth: getAuth(app),
            db: getFirestore(app),
            GoogleAuthProvider: GoogleAuthProvider,
            signInWithPopup: signInWithPopup,
            onAuthStateChanged: onAuthStateChanged,
            signOut: signOut
        };

        // Signal that Firebase is ready for the main app script to use
        document.dispatchEvent(new Event('firebase-ready'));
    </script>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-card">
            <div class="splash-logo">ðŸ“·</div>
            <h1>FaceAttend</h1>
            <p class="text-secondary">Admin Login Required</p>
            <button id="login-btn" class="btn btn-primary btn-google">
                 <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48"><g><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></g></svg>
                <span>Sign in with Google</span>
            </button>
            <p id="auth-status" class="auth-status"></p>
        </div>
    </div>

    <!-- Main Application Container (Initially Hidden) -->
    <div id="app-container" class="hidden">
        <nav class="nav">
            <div class="nav-container">
                <div class="nav-brand"><h2>FaceAttend</h2></div>
                <div class="nav-links">
                    <button class="nav-btn active" data-section="dashboard">Dashboard</button>
                    <button class="nav-btn" data-section="registration">Registration</button>
                    <button class="nav-btn" data-section="attendance">Attendance</button>
                    <button class="nav-btn" data-section="reports">Reports</button>
                    <button class="nav-btn" data-section="admin">Admin</button>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>
                    <button class="theme-toggle" id="themeToggle">ðŸŒ™</button>
                </div>
            </div>
        </nav>

        <main class="main-container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="container">
                    <div class="section-header">
                        <h1 id="welcome-message">Dashboard</h1>
                        <p class="text-secondary">Welcome to FaceAttend - Manage your attendance system</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ‘¥</div>
                            <div class="stat-content">
                                <h3 id="totalStudents">0</h3>
                                <p>Total Students</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ“š</div>
                            <div class="stat-content">
                                <h3 id="totalSessions">0</h3>
                                <p>Total Sessions</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">âœ…</div>
                            <div class="stat-content">
                                <h3 id="todayAttendance">0</h3>
                                <p>Today's Attendance</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ“Š</div>
                            <div class="stat-content">
                                <h3 id="averageAttendance">0%</h3>
                                <p>Average Attendance</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Registration Section -->
            <section id="registration" class="section">
                <div class="container">
                    <div class="section-header">
                        <h1>Student Registration</h1>
                        <p class="text-secondary">Register new students for facial recognition</p>
                    </div>
                    <div class="registration-container">
                        <div class="card">
                            <div class="card-header"><h3>Add New Student</h3></div>
                            <div class="card-content">
                                <form id="studentRegistrationForm" onsubmit="event.preventDefault();">
                                    <div class="form-group"><label for="studentId">Student ID</label><input type="text" id="studentId" placeholder="e.g., 12345" required></div>
                                    <div class="form-group"><label for="studentName">Full Name</label><input type="text" id="studentName" placeholder="e.g., Jane Doe" required></div>
                                    <div class="form-group"><label for="studentCourse">Course</label><select id="studentCourse" required><option value="">Select Course</option><option value="Computer Science">Computer Science</option><option value="Information Technology">Information Technology</option><option value="Business Administration">Business Administration</option></select></div>
                                    <div class="form-group"><label for="studentEmail">Email</label><input type="email" id="studentEmail" placeholder="e.g., jane.doe@example.com"></div>
                                </form>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Capture Photo</h3></div>
                            <div class="card-content">
                                <div class="camera-container">
                                    <video id="registrationVideo" class="camera-feed" autoplay muted playsinline></video>
                                    <canvas id="registrationCanvas" style="display: none;"></canvas>
                                </div>
                                <div class="camera-controls">
                                    <button id="startRegistrationCamera" class="btn btn-primary">Start Camera</button>
                                    <button id="capturePhoto" class="btn btn-secondary" disabled>Capture Photo</button>
                                </div>
                                <div id="capturedPhotoPreview" class="photo-preview" style="display: none;">
                                    <img id="previewImage" alt="Captured photo">
                                </div>
                                <button id="registerStudent" class="btn btn-success" style="width: 100%; margin-top: 1rem;">Register Student</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Registered Students</h3></div>
                        <div class="card-content">
                            <div id="registeredStudentsList" class="students-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Attendance Section -->
            <section id="attendance" class="section">
                <div class="container">
                    <div class="section-header"><h1>Mark Attendance</h1></div>
                    <div class="attendance-container">
                        <div class="card">
                            <div class="card-header"><h3>Session Setup</h3></div>
                            <div class="card-content">
                                <div class="form-group"><label for="sessionCourse">Course</label><select id="sessionCourse" required><option value="">Select Course</option><option value="CS101">CS101 - Intro to Programming</option><option value="IT205">IT205 - Database Management</option><option value="BA330">BA330 - Marketing Principles</option></select></div>
                                <div class="session-controls">
                                    <button id="startSession" class="btn btn-primary">Start Session</button>
                                    <button id="endSession" class="btn btn-danger" disabled>End Session</button>
                                </div>
                                <div class="session-status" id="sessionStatus">No Active Session</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Face Recognition</h3></div>
                            <div class="card-content">
                                <div class="camera-container">
                                    <video id="attendanceVideo" class="camera-feed" autoplay muted playsinline></video>
                                    <div class="recognition-status" id="recognitionStatus">Camera Inactive</div>
                                </div>
                                <div class="camera-controls">
                                    <button id="startAttendanceCamera" class="btn btn-primary" disabled>Start Recognition</button>
                                    <button id="stopAttendanceCamera" class="btn btn-outline" disabled>Stop Recognition</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>Live Attendance</h3>
                            <!-- FIX #2: Added the attendance count element -->
                            <span class="text-secondary">Count: <strong id="attendanceCount">0</strong></span>
                        </div>
                        <div class="card-content">
                            <div id="liveAttendanceList" class="attendance-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="section">
                <div class="container">
                    <div class="section-header"><h1>Attendance Reports</h1></div>
                    <div class="card">
                        <div class="card-header"><h3>Filter Options</h3></div>
                        <div class="card-content">
                             <div class="form-row">
                                <div class="form-group"><label for="reportCourse">Course</label><select id="reportCourse"><option value="">All Courses</option><option value="CS101">CS101 - Intro to Programming</option><option value="IT205">IT205 - Database Management</option><option value="BA330">BA330 - Marketing Principles</option></select></div>
                                <div class="form-group"><label for="reportStudent">Student</label><select id="reportStudent"><option value="">All Students</option><!-- Student options are populated dynamically by app.js --></select></div>
                            </div>
                            <button id="generateReport" class="btn btn-primary">Generate Report</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Report Results</h3></div>
                        <div class="card-content">
                            <!-- FIX #4: Added the canvas element for the chart -->
                            <div style="height: 300px; margin-bottom: 1rem; position: relative;">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                            <div id="reportResults"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Section -->
            <section id="admin" class="section">
                <div class="container">
                    <div class="section-header"><h1>Admin Panel</h1></div>
                    <div class="admin-grid">
                        <div class="card">
                            <div class="card-header"><h3>System Settings</h3></div>
                            <div class="card-content">
                                <div class="form-group"><label for="gemini-api-key">Gemini API Key</label><input type="password" id="gemini-api-key" placeholder="Enter your Google AI API Key"></div>
                                <button id="saveSettings" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Data Management</h3></div>
                            <div class="card-content">
                                <button id="backupData" class="btn btn-secondary">Backup Data</button>
                                <button id="clearAllData" class="btn btn-danger">Clear All Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="loadingOverlay" class="loading-overlay"><div class="loading-spinner"><div class="spinner"></div><p id="loadingText">Loading...</p></div></div>
    <div id="toast" class="toast"></div>

    <!-- This is the single entry point to our application -->
    <script type="module">
        import { app } from './app.js';
        // Wait until our Firebase services are ready before initializing the main app
        document.addEventListener('firebase-ready', () => {
            app.init();
        });
    </script>
</body>
</html>


